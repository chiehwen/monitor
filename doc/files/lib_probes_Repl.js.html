<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;probes&#x2F;Repl.js - monitor</title>
    <link rel="stylesheet" href="..&#x2F;assets/css/cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="..&#x2F;assets/css/combo-min.css" id="site_styles">
    <script src="..&#x2F;assets/js/yui-min.js"></script>
    <script src="..&#x2F;assets/js/combo-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html">Node.js Monitor</a> <span class="version">v0.4.0</span></h1>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Config.html">Config</a></li>
            
                <li><a href="..&#x2F;classes/Connection.html">Connection</a></li>
            
                <li><a href="..&#x2F;classes/ConnectionTest.html">ConnectionTest</a></li>
            
                <li><a href="..&#x2F;classes/FileProbe.html">FileProbe</a></li>
            
                <li><a href="..&#x2F;classes/FileProbeTest.html">FileProbeTest</a></li>
            
                <li><a href="..&#x2F;classes/Monitor.html">Monitor</a></li>
            
                <li><a href="..&#x2F;classes/MonitorTest.html">MonitorTest</a></li>
            
                <li><a href="..&#x2F;classes/PollingProbe.html">PollingProbe</a></li>
            
                <li><a href="..&#x2F;classes/Probe.html">Probe</a></li>
            
                <li><a href="..&#x2F;classes/ProbeTest.html">ProbeTest</a></li>
            
                <li><a href="..&#x2F;classes/Process.html">Process</a></li>
            
                <li><a href="..&#x2F;classes/Repl.html">Repl</a></li>
            
                <li><a href="..&#x2F;classes/Router.html">Router</a></li>
            
                <li><a href="..&#x2F;classes/RouterTest.html">RouterTest</a></li>
            
                <li><a href="..&#x2F;classes/Server.html">Server</a></li>
            
                <li><a href="..&#x2F;classes/ServerTest.html">ServerTest</a></li>
            
                <li><a href="..&#x2F;classes/Storage.html">Storage</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/Monitor.html">Monitor</a></li>
            
                <li><a href="..&#x2F;modules/Probes.html">Probes</a></li>
            
                <li><a href="..&#x2F;modules/UnitTests.html">UnitTests</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;probes&#x2F;Repl.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;&#x2F; Dependencies
var util = require(&#x27;util&#x27;),
    events = require(&#x27;events&#x27;),
    CONFIG = require(&#x27;config&#x27;),
    Monitor = require(&#x27;..&#x2F;monitor&#x27;),
    ChildProcess = require(&#x27;child_process&#x27;),
    Probe = require(&#x27;..&#x2F;probe&#x27;);

&#x2F;&#x2F; Statics
var CONSOLE_PROMPT = &#x27;&gt; &#x27;;

&#x2F;&#x2F; Define and register the class
var classDefinition = {
  id: null,
  name: &#x27;ReplConsole&#x27;,
  description: &#x27;A socket.io based Read-Execute-Print-Loop console for node.js processes.&#x27;,
  defaultParameters: {
  },
  parameterDescriptions: {
  }
};

&#x2F;**
 * A probe based Read-Execute-Print-Loop console for node.js processes
 *
 * @class Repl
 * @extends Probe
 * @constructor
 *&#x2F;
var Repl = module.exports = function (name, config) {

  &#x2F;&#x2F; Call super constructor
  Repl.super_.call(this, classId, name, config);
};

&#x2F;&#x2F; Node.js style class inheritence
util.inherits(Repl, Probe);
var proto_ = Repl.prototype;
var super_ = Repl.super_.prototype;

&#x2F;&#x2F; Register the probe class
var classId = Monitor.registerClass(Repl, classDefinition);

&#x2F;**
 * Start the REPl console.
 *
 * @method start
 * @param {Function} callback(error) - (optional) Called when the monitor has started
 *&#x2F;
proto_.start = function(callback) {
  &#x2F;&#x2F; Call the parent start
  var t = this;
  super_.start.call(t);

  &#x2F;&#x2F; Start up the console
  t.stream = new ReplStream(t);
  t.repl = require(&#x27;repl&#x27;).start(CONSOLE_PROMPT, t.stream);
  t.htmlConsole = new HtmlConsole(t);
  t.shellCmd = null;
  t.repl.context.console = t.htmlConsole;
  if (callback) callback(null);
}

&#x2F;**
 * Stop the REPL console.  Consoles live 1-1 with a UI counterpart, so stop
 * requests exit the underlying repl console.  If the probe is re-started it
 * will get a new repl stream and console.
 *
 * @method stop
 * @param {Function} callback(error) - (optional) Called when the monitor has started
 *&#x2F;
proto_.stop = function(callback) {
  var t = this;
  t.stream = null;
  t.repl = null;
  super_.stop.call(t);
  if (callback) callback(null);
}

&#x2F;**
 * Handle a control event sent to this probe.
 *
 * @method onControl
 * @param {ControlEvent} event - The ControlEvent object
 * @param {Function} callback(error, {Mixed}) - Called when complete
 *&#x2F;
proto_.onControl = function(controlEvent, callback) {

  &#x2F;&#x2F; Process the control event
  var t = this, name = controlEvent.name, data = controlEvent.data;
  switch (name) {
    case &#x27;autocomplete&#x27;:
      return callback(null, t.repl.complete(data));
    case &#x27;input&#x27;:
      if (data == &#x27;.break&#x27; &amp;&amp; t.shellCmd) t.shellCmd.kill();
      return callback(null, t.stream.emit(&#x27;data&#x27;, data));
    case &#x27;sh&#x27;:
      return callback(null, t.runShellCmd(data));
    default:
      return super_.onControl.call(t, controlEvent, callback);
  }
}

&#x2F;**
 * Run a shell command and emit the output to the browser.
 *
 * @method runShellCmd
 * @param {String} command - The shell command to invoke
 *&#x2F;
proto_.runShellCmd = function(command) {
  var t = this;
  t.shellCmd = ChildProcess.exec(command, function(err, stdout, stderr) {
    if (err) {
      var outstr = &#x27;exit&#x27;;
      if (err.code) outstr += &#x27; (&#x27; + err.code + &#x27;)&#x27;;
      if (err.signal) outstr += &#x27; &#x27; + err.signal;
      t.emitMonitorEvent(&#x27;output&#x27;, outstr);
    }
    if (stdout.length) t.emitMonitorEvent(&#x27;output&#x27;, stdout);
    if (stderr.length) t.emitMonitorEvent(&#x27;output&#x27;, stderr);
    t.emitMonitorEvent(&#x27;output&#x27;, CONSOLE_PROMPT);
    t.shellCmd = null;
  });
  return null;
}

&#x2F;&#x2F; Define an internal stream class for the probe
var ReplStream = function(probe){
  var t = this;
  t.probe = probe;
  events.EventEmitter.call(t);
  t.setEncoding &amp;&amp; t.setEncoding(&#x27;utf-8&#x27;);
};
util.inherits(ReplStream, events.EventEmitter);
ReplStream.prototype.readable = true;
ReplStream.prototype.writable = true;
[&#x27;pause&#x27;,&#x27;resume&#x27;,&#x27;destroySoon&#x27;,&#x27;pipe&#x27;, &#x27;end&#x27;]
  .forEach(function(fnName){
    ReplStream.prototype[fnName] = function(){
      console.log(&quot;REPL Stream function unexpected: &quot; + fnName);
    }
  });
[&#x27;resume&#x27;]
  .forEach(function(fnName){
    ReplStream.prototype[fnName] = function(){
      &#x2F;&#x2F; Handled
    }
  });
ReplStream.prototype.write = function(data) {
  var t = this;
  t.probe.emitMonitorEvent(&#x27;output&#x27;, data);
};
ReplStream.prototype.destroy = function(data) {
  var t = this;
console.log(&quot;REPL stream destroy &quot; + t.probe.id);
  t.probe.stop();
};

&#x2F;&#x2F; Define format if it&#x27;s not in util.
var formatRegExp = &#x2F;%[sdj]&#x2F;g;
var format = util.format || function (f) {
  if (typeof f !== &#x27;string&#x27;) {
    var objects = [];
    for (var i = 0; i &lt; arguments.length; i++) {
      objects.push(util.inspect(arguments[i]));
    }
    return objects.join(&#x27; &#x27;);
  }
  var i = 1;
  var args = arguments;
  var str = String(f).replace(formatRegExp, function(x) {
    switch (x) {
      case &#x27;%s&#x27;: return String(args[i++]);
      case &#x27;%d&#x27;: return Number(args[i++]);
      case &#x27;%j&#x27;: return JSON.stringify(args[i++]);
      default:
        return x;
    }
  });
  for (var len = args.length, x = args[i]; i &lt; len; x = args[++i]) {
    if (x === null || typeof x !== &#x27;object&#x27;) {
      str += &#x27; &#x27; + x;
    } else {
      str += &#x27; &#x27; + util.inspect(x);
    }
  }
  return str;
}

&#x2F;&#x2F; Re-define the console so it goes to the HTML window
var HtmlConsole = function(probe){
  this.probe = probe;
};
HtmlConsole.prototype.log = function(msg) {
  this.probe.emitMonitorEvent(&#x27;output&#x27;, format.apply(this, arguments));
}
HtmlConsole.prototype.info = HtmlConsole.prototype.log;
HtmlConsole.prototype.warn = HtmlConsole.prototype.log;
HtmlConsole.prototype.error = HtmlConsole.prototype.log;
HtmlConsole.prototype.dir = function(object) {
  this.probe.emitMonitorEvent(&#x27;output&#x27;, util.inspect(object));
};
var times = {};
HtmlConsole.prototype.time = function(label) {
  times[label] = Date.now();
};
HtmlConsole.prototype.timeEnd = function(label) {
  var duration = Date.now() - times[label];
  this.log(&#x27;%s: %dms&#x27;, label, duration);
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="ft">
        <div class="footer-left">
          Copyright &copy; 2012 <a href="https://github.com/lorenwest/node-monitor">Loren West, and other contributors</a>. All rights reserved.
        </div>
        <div class="footer-right">
          Docs generated using <a href="https://github.com/davglass/yuidocjs">YUIDoc JS</a>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
