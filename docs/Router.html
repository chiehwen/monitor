<!DOCTYPE html>  <html> <head>   <title>Router.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Connection.html">                 Connection.js               </a>                                           <a class="source" href="Monitor.html">                 Monitor.js               </a>                                           <a class="source" href="Probe.html">                 Probe.js               </a>                                           <a class="source" href="Router.html">                 Router.js               </a>                                           <a class="source" href="Server.html">                 Server.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="Config.html">                 Config.js               </a>                                           <a class="source" href="FileProbe.html">                 FileProbe.js               </a>                                           <a class="source" href="PollingProbe.html">                 PollingProbe.js               </a>                                           <a class="source" href="Process.html">                 Process.js               </a>                                           <a class="source" href="Repl.html">                 Repl.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Router.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Router.js (c) 2012 Loren West and other contributors
Node-monitor may be freely distributed under the MIT license.
For further details and documentation:
http://lorenwest.github.com/node-monitor</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Module loading</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Monitor</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Monitor</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Monitor&#39;</span><span class="p">),</span>
      <span class="nx">Cron</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Cron</span><span class="p">,</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">,</span>
      <span class="nx">Config</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">Probe</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Probe</span><span class="p">,</span>
      <span class="nx">Connection</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Connection</span><span class="p">,</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span>
      <span class="nx">SocketIO</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">io</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set if server-side</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">commonJS</span> <span class="o">?</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">).</span><span class="nx">hostname</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">  * Probe location and message routing</span>
<span class="cm">  *</span>
<span class="cm">  * The router is a class used internally to locate probes and connect</span>
<span class="cm">  * events so messages are correctly routed between probes and their monitors.</span>
<span class="cm">  *</span>
<span class="cm">  * It is a *singleton* class, designed to run one instance within</span>
<span class="cm">  * a monitor process, and accessed via the (protected) `getRouter()`</span>
<span class="cm">  * method of the &lt;a href=&quot;Monitor.html&quot;&gt;Monitor&lt;/a&gt; object.</span>
<span class="cm">  *</span>
<span class="cm">  * It manages all outbound requests to probes, either internally or externally</span>
<span class="cm">  * via the &lt;a href=&quot;Connection.html&quot;&gt;Connection&lt;/a&gt; to the remote process.</span>
<span class="cm">  *</span>
<span class="cm">  * @class Router</span>
<span class="cm">  * @extends Backbone.Model</span>
<span class="cm">  * @constructor</span>
<span class="cm">  */</span>
  <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">defaultGateway</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">connections</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Connection</span><span class="p">.</span><span class="nx">List</span><span class="p">();</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesByKey</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// key=probeKey, data=probeImpl</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesById</span> <span class="o">=</span> <span class="p">{};</span>  <span class="c1">// key=probeId, data=probeImpl</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Firewall new connections from inbound probe requests</span>
<span class="cm">    *</span>
<span class="cm">    * This method is used to inform new connections if they can use this</span>
<span class="cm">    * process for inbound probe requests.</span>
<span class="cm">    *</span>
<span class="cm">    * @static</span>
<span class="cm">    * @method setFirewall</span>
<span class="cm">    * @param firewall {Boolean} - Firewall new connections?</span>
<span class="cm">    */</span>
    <span class="nx">setFirewall</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">getRouter</span><span class="p">();</span> <span class="c1">// This is a static method</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">gateway</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>     <span class="c1">// New connection can&#39;t be an inbound gateway</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">defaultGateway</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">addConnection</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Set the default gateway server</span>
<span class="cm">    *</span>
<span class="cm">    * The gateway server is used if a monitor cannot connect directly with the</span>
<span class="cm">    * server hosting the probe.</span>
<span class="cm">    *</span>
<span class="cm">    * When a monitor is requested to connect with a probe on a specific server,</span>
<span class="cm">    * a direct connection is attempted.  If that direct connection fails, usually</span>
<span class="cm">    * due to a firewall or browser restriction, the monitor will attempt the</span>
<span class="cm">    * connection to the probe through the gateway server.</span>
<span class="cm">    *</span>
<span class="cm">    * The server specified in this method must be an approved gateway.</span>
<span class="cm">    *</span>
<span class="cm">    * @static</span>
<span class="cm">    * @method setGateway</span>
<span class="cm">    * @param options {Object} - Connection parameters</span>
<span class="cm">    *   @param options.hostName {String} - Name of the gateway host</span>
<span class="cm">    *   @param options.hostPort {Integer} - Port number to connect with</span>
<span class="cm">    *   @param options.url {String} - The URL used to connect (created, or used if supplied)</span>
<span class="cm">    *   @param options.socket {io.socket} - Pre-connected socket.io socket to the gateway server.</span>
<span class="cm">    * @return connection {Connection} - The connection with the gateway server</span>
<span class="cm">    */</span>
    <span class="nx">setGateway</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">getRouter</span><span class="p">();</span> <span class="c1">// This is a static method</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">gateway</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>     <span class="c1">// New connection can&#39;t be an inbound gateway</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">defaultGateway</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">addConnection</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Return a stable host name.</span>
<span class="cm">    *</span>
<span class="cm">    * @method getHostName</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @return hostName {String} - The platform&#39;s host name, or an otherwise stable ID</span>
<span class="cm">    */</span>
    <span class="nx">getHostName</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">localStorage</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hostName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">)</span> <span class="p">{</span><span class="nx">hostName</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">hostName</span><span class="p">;}</span>
        <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">hostName</span> <span class="o">||</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">generateUniqueId</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">)</span> <span class="p">{</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">hostName</span> <span class="o">=</span> <span class="nx">hostName</span><span class="p">;}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">hostName</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Set the current host name.</span>
<span class="cm">    *</span>
<span class="cm">    * This sets the host name that this router publishes to new connections.</span>
<span class="cm">    * It&#39;s only useful if the os hostname isn&#39;t the name you want to publish.</span>
<span class="cm">    *</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @method setHostName</span>
<span class="cm">    * @param hostName {String} - The host name to publish to new connections</span>
<span class="cm">    */</span>
    <span class="nx">setHostName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Add a connection to a remote Monitor process</span>
<span class="cm">    *</span>
<span class="cm">    * @method addConnection</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param options {Object} - Connection parameters</span>
<span class="cm">    *   hostName {String} - Name of the host to connect with</span>
<span class="cm">    *   hostPort {Integer} - Port number to connect with</span>
<span class="cm">    *   url {String} - The URL used to connect (created, or used if supplied)</span>
<span class="cm">    *   socket {io.socket} - Pre-connected socket.io socket to a Monitor server.</span>
<span class="cm">    *   gateway {Boolean} - Allow this connection to use me as a gateway (default false)</span>
<span class="cm">    * @return connection {Connection} - The added connection</span>
<span class="cm">    */</span>
    <span class="nx">addConnection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Connection</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Add the connection once connected</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">t</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">connection</span><span class="p">);});</span>
      <span class="k">return</span> <span class="nx">connection</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Remove a connection from the router.</span>
<span class="cm">    *</span>
<span class="cm">    * This is called to remove the connection and associated routes from the router.</span>
<span class="cm">    *</span>
<span class="cm">    * @method removeConnection</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param connection {Connection} - The connection to remove</span>
<span class="cm">    */</span>
    <span class="nx">removeConnection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="s1">&#39;connection_removed&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Connect a Monitor object to a remote Probe</span>
<span class="cm">    *</span>
<span class="cm">    * This accepts an instance of a Monitor and figures out how to connect it</span>
<span class="cm">    * to a running Probe.</span>
<span class="cm">    *</span>
<span class="cm">    * Upon callback the probe data is set into the monitor (unless an error</span>
<span class="cm">    * occurred)</span>
<span class="cm">    *</span>
<span class="cm">    * @method connectMonitor</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param monitor {Monitor} - The monitor requesting to connect with the probe</span>
<span class="cm">    * @param callback {Function(error)} - (optional) Called when connected</span>
<span class="cm">    */</span>
    <span class="nx">connectMonitor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">monitor</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){};</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">monitorJSON</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">probeJSON</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
          <span class="nx">probeClass</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">probeClass</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Class name must be set</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">probeClass</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;probeClass must be set&#39;</span><span class="p">);}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Determine the connection (or internal), and listen for change events</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">t</span><span class="p">.</span><span class="nx">determineConnection</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Function to run on connection (internal or external)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">onConnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">probe</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);}</span>
          <span class="nx">probeJSON</span> <span class="o">=</span> <span class="nx">probe</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
          <span class="nx">probeJSON</span><span class="p">.</span><span class="nx">probeId</span> <span class="o">=</span> <span class="nx">probeJSON</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span> <span class="k">delete</span> <span class="nx">probeJSON</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
          <span class="nx">monitor</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">probeJSON</span><span class="p">);</span>
          <span class="nx">monitor</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="nx">probe</span><span class="p">;</span>
          <span class="nx">monitor</span><span class="p">.</span><span class="nx">probeChange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">monitor</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">probe</span><span class="p">.</span><span class="nx">changedAttributes</span><span class="p">());};</span>
          <span class="nx">probe</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">probeChange</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Connect internally or externally</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">connectExternal</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">onConnect</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">connectInternal</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">,</span> <span class="nx">onConnect</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Disconnect a monitor</span>
<span class="cm">    *</span>
<span class="cm">    * This accepts an instance of a connected monitor, and disconnects it from</span>
<span class="cm">    * the remote probe.</span>
<span class="cm">    *</span>
<span class="cm">    * The probe implementation will be released if this is the only monitor</span>
<span class="cm">    * object watching it.</span>
<span class="cm">    *</span>
<span class="cm">    * @method disconnectMonitor</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param monitor {Monitor} - The connected monitor</span>
<span class="cm">    * @param reason {String} - Reason for the disconnect</span>
<span class="cm">    * @param callback {Function(error)} - (optional) Called when connected</span>
<span class="cm">    */</span>
    <span class="nx">disconnectMonitor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">monitor</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){};</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">probe</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">probe</span><span class="p">,</span> <span class="nx">probeId</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;probeId&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The monitor must be connected</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">probe</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;Monitor must be connected&#39;</span><span class="p">);}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Called upon disconnect (internal or external)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">onDisconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);}</span>
          <span class="nx">probe</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">probeChange</span><span class="p">);</span>
          <span class="nx">monitor</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">probeChange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">monitor</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">probeId</span><span class="o">:</span><span class="kc">null</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
      <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Disconnect from an internal or external probe</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">probe</span><span class="p">.</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">disconnectExternal</span><span class="p">(</span><span class="nx">probe</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">probeId</span><span class="p">,</span> <span class="nx">onDisconnect</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">disconnectInternal</span><span class="p">(</span><span class="nx">probeId</span><span class="p">,</span> <span class="nx">onDisconnect</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Build a probe key from the probe data</span>
<span class="cm">    *</span>
<span class="cm">    * @method buildProbeKey</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param probeJSON {Object} - An object containing:</span>
<span class="cm">    *     @param probeJSON.probeClass {String} - The probe class name (required)</span>
<span class="cm">    *     @param probeJSON.initParams {Object} - Probe initialization parameters (if any)</span>
<span class="cm">    * @return probeKey {String} - A string identifying the probe</span>
<span class="cm">    */</span>
    <span class="nx">buildProbeKey</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">probeJSON</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">probeKey</span> <span class="o">=</span> <span class="nx">probeJSON</span><span class="p">.</span><span class="nx">probeClass</span><span class="p">,</span> <span class="nx">initParams</span> <span class="o">=</span> <span class="nx">probeJSON</span><span class="p">.</span><span class="nx">initParams</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">initParams</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">initParams</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
          <span class="nx">probeKey</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">initParams</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">probeKey</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Determine the connection to use for a probe</span>
<span class="cm">    *</span>
<span class="cm">    * This uses the connection parameters of the specified monitor to determine</span>
<span class="cm">    * (or create) the connection to use for the probe.</span>
<span class="cm">    *</span>
<span class="cm">    * If the probe can be instantiated internally, a null is returned as the</span>
<span class="cm">    * connection.</span>
<span class="cm">    *</span>
<span class="cm">    * This attempts to use an existing connection if available.  If not, a</span>
<span class="cm">    * connection attempt will be made with the host. If the host cannot be</span>
<span class="cm">    * reached directly, it returns a connection with the gateway.</span>
<span class="cm">    *</span>
<span class="cm">    * @method determineConnection</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param monitorJSON {Object} - The connection attributes of the monitor</span>
<span class="cm">    * @param makeNewConnections {Boolean} - Establish a new connection if one doesn&#39;t exist?</span>
<span class="cm">    * @param callback {Function(error, connection)} - Called when the connection is known</span>
<span class="cm">    * &lt;ul&gt;</span>
<span class="cm">    *   &lt;li&gt;error - Set if any errors&lt;/li&gt;</span>
<span class="cm">    *   &lt;li&gt;connection - The connection object, or null to run in this process&lt;/li&gt;</span>
<span class="cm">    * &lt;ul&gt;</span>
<span class="cm">    */</span>
    <span class="nx">determineConnection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">,</span> <span class="nx">makeNewConnections</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">connection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">probeClass</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">probeClass</span><span class="p">,</span>
          <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">hostName</span><span class="p">,</span> <span class="nx">appName</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">appName</span><span class="p">,</span>
          <span class="nx">appInstance</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">appInstance</span><span class="p">,</span>
          <span class="nx">thisHostName</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">getHostName</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="nx">thisAppName</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">appName</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Connect with this process (internally)?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">hostName</span> <span class="o">?</span> <span class="nx">hostName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">hostName</span> <span class="o">||</span> <span class="nx">hostName</span> <span class="o">===</span> <span class="nx">thisHostName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">appName</span> <span class="o">||</span> <span class="nx">appName</span> <span class="o">===</span> <span class="nx">thisAppName</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Return if connection is known</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">connection</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">findConnection</span><span class="p">(</span><span class="nx">hostName</span><span class="p">,</span> <span class="nx">appName</span><span class="p">,</span> <span class="nx">appInstance</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>See if we can establish new connections with the host</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">hostName</span> <span class="o">&amp;&amp;</span> <span class="nx">makeNewConnections</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">addHostConnections</span><span class="p">(</span><span class="nx">hostName</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">connection</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">findConnection</span><span class="p">(</span><span class="nx">hostName</span><span class="p">,</span> <span class="nx">appName</span><span class="p">,</span> <span class="nx">appInstance</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Cant establish a direct connection.  Use gateway if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">defaultGateway</span><span class="p">)</span> <span class="p">{</span><span class="nx">err</span> <span class="o">=</span> <span class="nx">err</span> <span class="o">||</span> <span class="s1">&#39;No route to host: &#39;</span> <span class="o">+</span> <span class="nx">hostName</span><span class="p">;}</span>
            <span class="k">else</span> <span class="p">{</span><span class="nx">connection</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">defaultGateway</span><span class="p">;}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;No host specified for app: &#39;</span> <span class="o">+</span> <span class="nx">appName</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Find an existing connection to use</span>
<span class="cm">    *</span>
<span class="cm">    * This method looks into the existing known connections to find one</span>
<span class="cm">    * that matches the specified parameters.</span>
<span class="cm">    *</span>
<span class="cm">    * @method findConnection</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param hostName {String} - Host name to find a connection for (null = any host)</span>
<span class="cm">    * @param appName {String} - App name to find a connection with (null = any app)</span>
<span class="cm">    * @param appInstance {Integer} - Index into the list of hostName/appName matches (default: 0)</span>
<span class="cm">    * @return connection {Connection} - A Connection object if found, otherwise null</span>
<span class="cm">    */</span>
    <span class="nx">findConnection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hostName</span><span class="p">,</span> <span class="nx">appName</span><span class="p">,</span> <span class="nx">appInstance</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">thisInstance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Host or app matches if not specified or if specified and equal</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">matchesHost</span> <span class="o">=</span> <span class="o">!</span><span class="nx">hostName</span> <span class="o">||</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">isThisHost</span><span class="p">(</span><span class="nx">hostName</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">matchesApp</span> <span class="o">=</span> <span class="o">!</span><span class="nx">appName</span> <span class="o">||</span> <span class="nx">appName</span> <span class="o">===</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;remoteAppName&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">remoteFirewall</span> <span class="o">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;remoteFirewall&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>This is a match if host + app + instance matches, and it's not firewalled</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">remoteFirewall</span> <span class="o">&amp;&amp;</span> <span class="nx">matchesHost</span> <span class="o">&amp;&amp;</span> <span class="nx">matchesApp</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">thisInstance</span><span class="o">++</span> <span class="o">===</span> <span class="nx">appInstance</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>No match</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Add connections for the specified host</span>
<span class="cm">    *</span>
<span class="cm">    * This performs a scan of monitor ports on the server, and adds connections</span>
<span class="cm">    * for newly discovered servers.</span>
<span class="cm">    *</span>
<span class="cm">    * @method addHostConnections</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param hostName {String} - The host to add connections with</span>
<span class="cm">    * @param callback {Function(error)} - Called when complete</span>
<span class="cm">    */</span>
    <span class="nx">addHostConnections</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hostName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">connectedPorts</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">portStart</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">serviceBasePort</span><span class="p">,</span>
          <span class="nx">portEnd</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">serviceBasePort</span> <span class="o">+</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">portsToScan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Build the list of ports already connected</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">t</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hostName&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hostPort&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">host</span> <span class="o">===</span> <span class="nx">hostName</span> <span class="o">&amp;&amp;</span> <span class="nx">port</span> <span class="o">&gt;=</span> <span class="nx">portStart</span> <span class="o">&amp;&amp;</span> <span class="nx">port</span> <span class="o">&lt;=</span> <span class="nx">portEnd</span><span class="p">)</span> <span class="p">{</span><span class="nx">connectedPorts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">port</span><span class="p">);}</span>
      <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Scan non-connected ports</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">portsToScan</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">portsToScan</span> <span class="o">-</span> <span class="nx">connectedPorts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">callbackWhenDone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;connect disconnect error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">whenDone</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">portsToScan</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="nx">callback</span><span class="p">();}</span>
      <span class="p">};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">portStart</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">portEnd</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">connectedPorts</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">addConnection</span><span class="p">({</span><span class="nx">hostName</span><span class="o">:</span><span class="nx">hostName</span><span class="p">,</span> <span class="nx">hostPort</span><span class="o">:</span><span class="nx">i</span><span class="p">});</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">whenDone</span> <span class="o">=</span> <span class="nx">callbackWhenDone</span><span class="p">;</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect disconnect error&#39;</span><span class="p">,</span> <span class="nx">callbackWhenDone</span><span class="p">,</span> <span class="nx">connection</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Connect to an internal probe implementation</span>
<span class="cm">    *</span>
<span class="cm">    * This connects with a probe running in this process.  It will instantiate</span>
<span class="cm">    * the probe if it isn&#39;t currently running.</span>
<span class="cm">    *</span>
<span class="cm">    * @method connectInternal</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param monitorJSON {Object} - The monitor toJSON data.  Containing:</span>
<span class="cm">    *     @param monitorJSON.probeClass {String} - The probe class name to connect with (required)</span>
<span class="cm">    *     @param monitorJSON.initParams {Object} - Probe initialization parameters.</span>
<span class="cm">    * @param callback {Function(error, probeImpl)} - Called when connected</span>
<span class="cm">    */</span>
    <span class="nx">connectInternal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Build a key for this probe from the probeClass and initParams</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">probeKey</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">buildProbeKey</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">),</span>
          <span class="nx">probeClass</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">probeClass</span><span class="p">,</span> <span class="nx">initParams</span> <span class="o">=</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">initParams</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Get the probe instance</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">probeImpl</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesByKey</span><span class="p">[</span><span class="nx">probeKey</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">initOptions</span> <span class="o">=</span> <span class="p">{</span><span class="nx">asyncInit</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">probeImpl</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Instantiate &amp; remember</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">ProbeClass</span> <span class="o">=</span> <span class="nx">Probe</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="nx">probeClass</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ProbeClass</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="s1">&#39;Probe not available: &#39;</span> <span class="o">+</span> <span class="nx">probeClass</span><span class="p">});}</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">probeImpl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProbeClass</span><span class="p">(</span><span class="nx">initParams</span><span class="p">,</span> <span class="nx">initOptions</span><span class="p">);</span>
          <span class="nx">probeImpl</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nx">generateUniqueId</span><span class="p">()});</span>
          <span class="nx">probeImpl</span><span class="p">.</span><span class="nx">refCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">probeImpl</span><span class="p">.</span><span class="nx">probeKey</span> <span class="o">=</span> <span class="nx">probeKey</span><span class="p">;</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesByKey</span><span class="p">[</span><span class="nx">probeKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">probeImpl</span><span class="p">;</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesById</span><span class="p">[</span><span class="nx">probeImpl</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">probeImpl</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">{</span><span class="nx">msg</span><span class="o">:</span> <span class="s1">&#39;Error instantiating probe &#39;</span> <span class="o">+</span> <span class="nx">probeClass</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">e</span><span class="p">};</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Probes are released based on reference count</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">probeImpl</span><span class="p">.</span><span class="nx">refCount</span><span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Wait one tick before firing the callback.  This simulates a remote
connection, making the client callback order consistent, regardless
of a local or remote connection.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initOptions</span><span class="p">.</span><span class="nx">asyncInit</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">probeImpl</span><span class="p">);});</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Disconnect with an internal probe implementation.</span>
<span class="cm">    *</span>
<span class="cm">    * @method disconnectInternal</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param probeId {String} - The probe implementation ID to disconnect</span>
<span class="cm">    * @param callback {Function(error, probeImpl)} - Called when disconnected</span>
<span class="cm">    */</span>
    <span class="nx">disconnectInternal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">probeId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">probeImpl</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesById</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">probeImpl</span><span class="p">.</span><span class="nx">refCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Release probe resources &amp; internal references</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">probeImpl</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
        <span class="k">delete</span> <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesByKey</span><span class="p">[</span><span class="nx">probeImpl</span><span class="p">.</span><span class="nx">probeKey</span><span class="p">];</span>
        <span class="k">delete</span> <span class="nx">t</span><span class="p">.</span><span class="nx">runningProbesById</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">probeImpl</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Connect to an external probe implementation.</span>
<span class="cm">    *</span>
<span class="cm">    * This connects with a probe running in another process.  It will</span>
<span class="cm">    * coordinate the remote instantiation of the probe if it&#39;s not running.</span>
<span class="cm">    *</span>
<span class="cm">    * @method connectExternal</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param monitorJSON {Object} - An object containing:</span>
<span class="cm">    *     @param monitorJSON.probeClass {String} - The probe class name (required)</span>
<span class="cm">    *     @param monitorJSON.initParams {Object} - Probe initialization parameters (if any)</span>
<span class="cm">    * @param connection {Connection} - The connection to use</span>
<span class="cm">    * @param callback {Function(error, probeProxy)} - Called when connected</span>
<span class="cm">    */</span>
    <span class="nx">connectExternal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Build a key for this probe from the probeClass and initParams</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">probeKey</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">buildProbeKey</span><span class="p">(</span><span class="nx">monitorJSON</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Get the probe proxy</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">probeId</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbeIdsByKey</span><span class="p">[</span><span class="nx">probeKey</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">probeProxy</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbesById</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">probeProxy</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Connect with the remote probe</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">connectParams</span> <span class="o">=</span> <span class="p">{</span><span class="nx">probeClass</span><span class="o">:</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">probeClass</span><span class="p">,</span> <span class="nx">initParams</span><span class="o">:</span> <span class="nx">monitorJSON</span><span class="p">.</span><span class="nx">initParams</span><span class="p">};</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;probe:connect&#39;</span><span class="p">,</span> <span class="nx">connectParams</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">probeJSON</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Cannot connect to remote probe on host &#39;</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hostName&#39;</span><span class="p">),</span> <span class="nx">connectParams</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">probeId</span> <span class="o">=</span> <span class="nx">probeJSON</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
          <span class="nx">probeProxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Probe</span><span class="p">(</span><span class="nx">probeJSON</span><span class="p">);</span>
          <span class="nx">probeProxy</span><span class="p">.</span><span class="nx">refCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">probeProxy</span><span class="p">.</span><span class="nx">connection</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">;</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbeIdsByKey</span><span class="p">[</span><span class="nx">probeKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">probeId</span><span class="p">;</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbesById</span><span class="p">[</span><span class="nx">probeId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">probeProxy</span><span class="p">;</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;probe:change:&#39;</span> <span class="o">+</span> <span class="nx">probeId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">){</span><span class="nx">probeProxy</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">attrs</span><span class="p">);});</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">probeProxy</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Probes are released based on reference count</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">probeProxy</span><span class="p">.</span><span class="nx">refCount</span><span class="o">++</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">probeProxy</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">    * Disconnect with an external probe implementation.</span>
<span class="cm">    *</span>
<span class="cm">    * @method disconnectExternal</span>
<span class="cm">    * @protected</span>
<span class="cm">    * @param connection {Connection} - The connection to use</span>
<span class="cm">    * @param probeId {String} - Probe ID</span>
<span class="cm">    * @param callback {Function(error)} - Called when disconnected</span>
<span class="cm">    */</span>
    <span class="nx">disconnectExternal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">probeId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbesById</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">proxy</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;Probe not running&#39;</span><span class="p">);}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">refCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Release probe resources</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">proxy</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
        <span class="nx">proxy</span><span class="p">.</span><span class="nx">connection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbesById</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>
        <span class="k">delete</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">remoteProbeIdsByKey</span><span class="p">[</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">probeKey</span><span class="p">];</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">removeEvent</span><span class="p">(</span><span class="s1">&#39;probe:change:&#39;</span> <span class="o">+</span> <span class="nx">probeId</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;probe:disconnect&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">probeId</span><span class="o">:</span><span class="nx">probeId</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Probe disconnect error from host : &quot;</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hostName&#39;</span><span class="p">),</span> <span class="nx">error</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">});</span>

<span class="p">}(</span><span class="k">this</span><span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 